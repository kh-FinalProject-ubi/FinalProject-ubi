// ğŸ“ src/pages/welfarefacility/FacilityDetailPage.jsx
import React, { useState, useEffect } from "react";
import { useFacilities } from "../../hook/welfarefacility/useFacilities";
import FacilityCard from "../../components/welfarefacility/FacilityCard";
import useSelectedRegionStore from "../../hook/welfarefacility/useSelectedRegionStore";
import useLoginMember from "../../hook/login/useLoginMember";

export default function FacilityDetailPage({ city, district }) {
  const loginMember = useLoginMember(); // âœ… ë¡œê·¸ì¸ ì •ë³´

  const {
    selectedCity: selectedCityFromStore,
    selectedDistrict: selectedDistrictFromStore,
  } = useSelectedRegionStore();

  // âœ… ì§€ì—­ ìš°ì„ ìˆœìœ„: ë¡œê·¸ì¸ > store > props > ê¸°ë³¸ê°’
  const finalCity =
    loginMember?.memberAddressCity ||
    selectedCityFromStore ||
    city ||
    "ì„œìš¸íŠ¹ë³„ì‹œ";
  const finalDistrict =
    loginMember?.memberAddressDistrict ||
    selectedDistrictFromStore ||
    district ||
    "ì¢…ë¡œêµ¬";

  const [selectedServiceType, setSelectedServiceType] = useState("ì „ì²´");
  const [selectedCategory, setSelectedCategory] = useState("ì „ì²´");
  const [selectedOperator, setSelectedOperator] = useState("ì „ì²´");

  const {
    data: facilities,
    loading,
    error,
  } = useFacilities(finalCity, finalDistrict);

  const [benefits, setBenefits] = useState({});

  // âœ… ë³µì§€ í˜œíƒ ë¶ˆëŸ¬ì˜¤ê¸°
  useEffect(() => {
    const fetchBenefits = async () => {
      try {
        const res = await fetch("/api/welfare-curl/welfare-list/all");
        const data = await res.json();

        console.log("âœ… ì „ì²´ ì‘ë‹µ í™•ì¸:", data);
        if (!data || !Array.isArray(data.servList)) {
          console.warn("âš ï¸ servListê°€ ì—†ìŒ ë˜ëŠ” í˜•ì‹ì´ ì˜ëª»ë¨");
          return;
        }

        const grouped = {};
        data.servList.forEach((item) => {
          const region = item.jurMnofNm?.trim();
          if (!grouped[region]) grouped[region] = [];
          grouped[region].push(item);
        });

        console.log("âœ… í˜œíƒ key ëª©ë¡:", Object.keys(grouped));
        console.log("âœ… ë„˜ê¸°ëŠ” district:", `${finalCity} ${finalDistrict}`);

        setBenefits(grouped);
      } catch (err) {
        console.error("âŒ ë³µì§€ í˜œíƒ ë¡œë”© ì‹¤íŒ¨", err);
      }
    };

    fetchBenefits();
  }, [finalCity, finalDistrict]);

  // âœ… í•„í„°ë§
  const filteredFacilities = facilities.filter((facility) => {
    const svcType = facility["ë³µì§€ìœ í˜•"] || facility.SVC_TYPE || "";
    const category = facility["ì¹´í…Œê³ ë¦¬"] || facility.CATEGORY || "";
    const operator = facility["ìš´ì˜ê¸°ê´€"] || facility.OPERATOR || "";

    const typeMatch =
      selectedServiceType === "ì „ì²´" || svcType.includes(selectedServiceType);
    const categoryMatch =
      selectedCategory === "ì „ì²´" || category.includes(selectedCategory);
    const operatorMatch =
      selectedOperator === "ì „ì²´" || operator.includes(selectedOperator);

    return typeMatch && categoryMatch && operatorMatch;
  });

  return (
    <div className="facility-detail-page">
      <h2>ê³µê³µ ì„œë¹„ìŠ¤ ì¡°íšŒ</h2>

      <div style={{ marginBottom: "20px" }}>
        <strong>ì„ íƒ ì§€ì—­:</strong> {finalCity} {finalDistrict}
      </div>

      {/* í•„í„° ì˜ì—­ */}
      <div style={{ marginBottom: "30px" }}>
        <h3>ì •ì‹ í•„í„°</h3>

        {/* ë³µì§€ìœ í˜• */}
        <div>
          <label>
            <strong>ë³µì§€ ìœ í˜•: </strong>
          </label>
          {["ì§€ìì²´ í˜œíƒ", "ì§€ìì²´ ì‹œì„¤"].map((type) => (
            <label key={type} style={{ marginRight: "10px" }}>
              <input
                type="radio"
                name="serviceType"
                value={type}
                checked={selectedServiceType === type}
                onChange={() => setSelectedServiceType(type)}
              />
              {type}
            </label>
          ))}
        </div>

        {/* ì¹´í…Œê³ ë¦¬ */}
        <div style={{ marginTop: "10px" }}>
          <label>
            <strong>ì¹´í…Œê³ ë¦¬: </strong>
          </label>
          {["ë³µì§€ í˜œíƒ", "êµ¬ì¸", "ì˜ˆì•½", "ê¸°íƒ€"].map((cat) => (
            <label key={cat} style={{ marginRight: "10px" }}>
              <input
                type="radio"
                name="category"
                value={cat}
                checked={selectedCategory === cat}
                onChange={() => setSelectedCategory(cat)}
              />
              {cat}
            </label>
          ))}
          <br />
          {["ì²´ìœ¡ì‹œì„¤", "ìš”ì–‘ì‹œì„¤", "ì˜ë£Œì‹œì„¤", "í–‰ì •ì‹œì„¤", "ì§‘í•©ì‹œì„¤"].map(
            (cat) => (
              <label key={cat} style={{ marginRight: "10px" }}>
                <input
                  type="radio"
                  name="category"
                  value={cat}
                  checked={selectedCategory === cat}
                  onChange={() => setSelectedCategory(cat)}
                />
                {cat}
              </label>
            )
          )}
        </div>

        {/* ìš´ì˜ê¸°ê´€ */}
        <div style={{ marginTop: "10px" }}>
          <label>
            <strong>ìš´ì˜ê¸°ê´€: </strong>
          </label>
          <select
            value={selectedOperator}
            onChange={(e) => setSelectedOperator(e.target.value)}
          >
            <option value="ì „ì²´">ì „ì²´</option>
            <option value="ì‹œë¦½">ì‹œë¦½</option>
            <option value="êµ¬ë¦½">êµ¬ë¦½</option>
            <option value="ë¯¼ê°„">ë¯¼ê°„</option>
          </select>
        </div>
      </div>

      {/* ìƒíƒœ ë©”ì‹œì§€ */}
      {loading && <p>ë¡œë”© ì¤‘...</p>}
      {error && <p>ì‹œì„¤ ì •ë³´ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.</p>}
      {!loading && filteredFacilities.length === 0 && (
        <p>ë³µì§€ì‹œì„¤ ì •ë³´ê°€ ì—†ìŠµë‹ˆë‹¤. ì¶”í›„ ì—…ë°ì´íŠ¸ ì˜ˆì •ì…ë‹ˆë‹¤.</p>
      )}

      {/* ë³µì§€ì‹œì„¤ ì¹´ë“œ */}
      <div className="facility-list">
        {filteredFacilities.map((facility, index) => {
          const name = facility.FACLT_NM || facility["ì‹œì„¤ëª…"] || "ì´ë¦„ì—†ìŒ";
          const lat = facility.REFINE_WGS84_LAT;
          const lng = facility.REFINE_WGS84_LOGT;
          const city = facility.CTPRVN_NM || facility["ì‹œë„ëª…"] || "ì‹œë„ì—†ìŒ";

          const key =
            lat && lng ? `${name}-${lat}-${lng}` : `${name}-${city}-${index}`;

          return <FacilityCard key={key} facility={facility} />;
        })}
      </div>
    </div>
  );
}
