<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd" >
<mapper namespace="edu.kh.project.board.model.mapper.CommentMapper">
	
	<!-- 댓글 목록 조회 -->
	<select id="select" resultType="Comment">
	SELECT LEVEL, C.* FROM
	(SELECT COMMENT_NO, COMMENT_CONTENT,
	    TO_CHAR(COMMENT_DATE, 'YYYY"." MM"." DD"." HH24":" MI') COMMENT_DATE,
	    BOARD_NO, MEMBER_NO, MEMBER_NICKNAME, MEMBER_IMG, COMMENT_PARENT_NO, COMMENT_DEL_FL
	FROM "COMMENTS"
	JOIN MEMBER USING(MEMBER_NO)
	WHERE BOARD_NO = #{boardNo}) C
	WHERE COMMENT_DEL_FL = 'N'
	OR 0 != (SELECT COUNT(*) FROM "COMMENTS" SUB
					WHERE SUB.COMMENT_PARENT_NO = C.COMMENT_NO
					AND COMMENT_DEL_FL = 'N')
	START WITH COMMENT_PARENT_NO IS NULL
	CONNECT BY PRIOR COMMENT_NO = COMMENT_PARENT_NO
	ORDER SIBLINGS BY COMMENT_NO
	</select>
	 
	 <!-- 동적 SQL : <if>
	 	조건식을 작성할 수 있는 태그
	 	
	 	- else 문 없음
	 	- test 속성 : 조건식을 작성하는 속성
	  -->
	 
	 <!-- 댓글/자식 댓글 등록 -->
	 <insert id="insert">
	  INSERT INTO "COMMENTS"	
	  VALUES(SEQ_COMMENT_NO.NEXTVAL,
	  		  #{commentContent},
	  		  DEFAULT,
	  		  DEFAULT,
	  		  DEFAULT,
	  		  #{boardNo},
	  		  #{memberNo},
	  		  
	  		  <!-- 자식 댓글 -->
	  		  <if test="commentParentNo != 0">
	  		  	#{commentParentNo}
	  		  </if>
	  		  
	  		  <!-- 부모 댓글 -->
			<if test="commentParentNo == 0">
				NULL
			</if>
			 )
	 </insert>

	<!-- 댓글 삭제 서비스 -->
	<update id="delete">
	UPDATE "COMMENTS" SET
	COMMENT_DEL_FL = 'Y'
	WHERE COMMENT_NO = #{commentNo}	
	</update>	 

	<!-- 댓글 수정 서비스 -->
	<update id="update">
	UPDATE "COMMENTS" SET
	COMMENT_CONTENT = #{commentContent}
	WHERE COMMENT_NO = #{commentNo}
	</update>
	

</mapper>
