<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd" >
<mapper
	namespace="edu.kh.project.board.model.mapper.CommentMapper">

	<!-- 댓글 목록 조회 -->
	<select id="select" resultType="Comment">
		SELECT LEVEL,
		C.*
		FROM (
		SELECT
		C.COMMENT_NO,
		C.COMMENT_CONTENT,
		TO_CHAR(C.COMMENT_DATE, 'YYYY"."MM"."DD HH24":"MI') AS COMMENT_DATE,
		C.BOARD_NO,
		C.MEMBER_NO,
		M.MEMBER_NICKNAME,
		M.MEMBER_IMG,
		C.COMMENT_PARENT_NO,
		C.COMMENT_DEL_FL,

		-- 좋아요 수
		(SELECT COUNT(*)
		FROM COMMENT_LIKE CL
		WHERE CL.COMMENT_NO = C.COMMENT_NO) AS COMMENT_LIKE,

		-- 로그인한 회원의 좋아요 여부
		(SELECT COUNT(*)
		FROM COMMENT_LIKE CL
		WHERE CL.COMMENT_NO = C.COMMENT_NO
		AND CL.MEMBER_NO = #{memberNo}) AS COMMENT_LIKED

		FROM COMMENTS C
		JOIN
		MEMBER M ON C.MEMBER_NO = M.MEMBER_NO
		WHERE C.BOARD_NO = #{boardNo}
		) C
		WHERE C.COMMENT_DEL_FL = 'N'
		OR EXISTS (
		SELECT 1
		FROM COMMENTS SUB
		WHERE SUB.COMMENT_PARENT_NO = C.COMMENT_NO
		AND SUB.COMMENT_DEL_FL = 'N'
		)
		START WITH C.COMMENT_PARENT_NO IS NULL
		CONNECT BY PRIOR C.COMMENT_NO = C.COMMENT_PARENT_NO
		ORDER SIBLINGS BY C.COMMENT_NO
	</select>

	<!-- 동적 SQL : <if> 조건식을 작성할 수 있는 태그 - else 문 없음 - test 속성 : 조건식을 작성하는 속성 -->

	<!-- 댓글/자식 댓글 등록 -->
	<insert id="insert">
		INSERT INTO "COMMENTS"
		VALUES(SEQ_COMMENT_NO.NEXTVAL,
		#{commentContent},
		DEFAULT,
		DEFAULT,
		DEFAULT,
		#{boardNo},
		#{memberNo},

		<!-- 자식 댓글 -->
		<if test="commentParentNo != 0">
			#{commentParentNo},
		</if>

		<!-- 부모 댓글 -->
		<if test="commentParentNo == 0">
			NULL,
		</if>
		DEFAULT
		)
	</insert>

	<!-- 댓글 삭제 서비스 -->
	<update id="delete">
		UPDATE "COMMENTS" SET
		COMMENT_DEL_FL = 'Y'
		WHERE
		COMMENT_NO = #{commentNo}
	</update>

	<!-- 댓글 수정 서비스 -->
	<update id="update">
		UPDATE "COMMENTS" SET
		COMMENT_CONTENT =
		#{commentContent},
		COMMENT_UPDATE_DATE = SYSDATE
		WHERE COMMENT_NO =
		#{commentNo}
	</update>

	<!-- 좋아요 체크 -->
	<select id="checkCommentLike" resultType="_int">
		SELECT COUNT(*)
		FROM
		COMMENT_LIKE
		WHERE COMMENT_NO = #{commentNo}
		AND MEMBER_NO = #{memberNo}
	</select>

	<delete id="deleteCommentLike">
		DELETE FROM COMMENT_LIKE
		WHERE COMMENT_NO =
		#{commentNo}
		AND MEMBER_NO = #{memberNo}
	</delete>

	<insert id="insertCommentLike">
		INSERT INTO COMMENT_LIKE (COMMENT_NO, MEMBER_NO)
		VALUES (#{commentNo}, #{memberNo})
	</insert>

	<!-- 신고 체크 -->
	<update id="insertReport">
		UPDATE "COMMENTS" SET
		COMMENT_REPORT_COUNT =
		COMMENT_REPORT_COUNT +1
		WHERE COMMENT_NO =
		#{commentNo}

	</update>

	<!-- 신고 취소 -->
	<update id="deleteReport">
		UPDATE "COMMENTS"
		SET COMMENT_REPORT_COUNT = CASE
		WHEN
		COMMENT_REPORT_COUNT > 0 THEN COMMENT_REPORT_COUNT - 1
		ELSE 0
		END
		WHERE
		COMMENT_NO = #{commentNo}
	</update>


</mapper>
